<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${pageTitle} ?: '发布新博客'">发布新博客</title>
    <link rel="stylesheet" th:href="@{/css/style.css}">
</head>
<body>
<!-- 引用导航栏 -->
<div th:replace="~{fragments/common :: header}"></div>

<!-- 主内容区 -->
<main class="main-content">
    <div class="form-container">
        <h1>发布新博客</h1>

        <form action="/admin/blogs" method="post">
            <div class="form-group">
                <label for="title">标题</label>
                <input type="text" id="title" name="title" placeholder="请输入博客标题" required autofocus>
            </div>
            <div class="form-group">
                <label for="content">内容</label>
                <textarea id="content" name="content" placeholder="博客内容..." required></textarea>
            </div>
            <!-- 在 content 文本域后面添加 -->
            <div class="form-group">
                <label>上传图片</label>
                <div style="display: flex; gap: 10px;">
                    <input type="file" id="imageFile" accept="image/*">
                    <button type="button" id="uploadBtn" class="btn-secondary">上传图片</button>
                </div>
                <div id="uploadProgress" style="margin-top: 10px; color: #666;"></div>
                <div id="imagePreview" style="margin-top: 10px; display: flex; flex-wrap: wrap; gap: 10px;"></div>
            </div>
            <button type="submit" class="btn-primary">发布</button>
            <a href="/" class="btn-secondary">取消，返回首页</a>
        </form>
    </div>
</main>

<!-- 引用页脚 -->
<div th:replace="~{fragments/common :: footer}"></div>
<script>
    document.getElementById('uploadBtn').addEventListener('click', function() {
        const fileInput = document.getElementById('imageFile');
        const file = fileInput.files[0];

        if (!file) {
            alert('请选择要上传的图片');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        const progressDiv = document.getElementById('uploadProgress');
        progressDiv.innerHTML = '上传中...';

        fetch('/admin/upload/image', {
            method: 'POST',
            body: formData
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    progressDiv.innerHTML = '上传成功！';

                    // 在预览区域显示图片
                    const previewDiv = document.getElementById('imagePreview');
                    const imgContainer = document.createElement('div');
                    imgContainer.style.position = 'relative';
                    imgContainer.style.display = 'inline-block';

                    const img = document.createElement('img');
                    img.src = data.url;
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '200px';
                    img.style.borderRadius = '5px';

                    const insertBtn = document.createElement('button');
                    insertBtn.innerHTML = '插入到文章';
                    insertBtn.style.display = 'block';
                    insertBtn.style.marginTop = '5px';
                    insertBtn.style.padding = '3px 10px';
                    insertBtn.style.background = '#0066cc';
                    insertBtn.style.color = 'white';
                    insertBtn.style.border = 'none';
                    insertBtn.style.borderRadius = '3px';
                    insertBtn.style.cursor = 'pointer';

                    insertBtn.onclick = function() {
                        const textarea = document.getElementById('content');
                        textarea.value += `\n![图片](${data.url})\n`;
                        previewDiv.innerHTML = '';  // 清空预览
                        fileInput.value = '';       // 清空文件选择
                        progressDiv.innerHTML = '';
                    };

                    imgContainer.appendChild(img);
                    imgContainer.appendChild(insertBtn);
                    previewDiv.appendChild(imgContainer);
                } else {
                    progressDiv.innerHTML = '上传失败：' + data.message;
                }
            })
            .catch(error => {
                progressDiv.innerHTML = '上传出错：' + error;
            });
    });
</script>
<!-- ===== JavaScript 结束 ===== -->

</body>
</html>